(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))a(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&a(o)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();class y{constructor(){this.properties=[],this.currentLanguage=localStorage.getItem("language")||"fa",this.isAdminLoggedIn=localStorage.getItem("adminLoggedIn")==="true",this.isAdminLoggedIn=localStorage.getItem("adminLoggedIn")==="true",this.init()}async init(){document.documentElement.setAttribute("dir",this.currentLanguage==="fa"?"rtl":"ltr"),this.setupTheme(),this.setupLanguageSwitching(),await this.loadProperties(),this.setupNavigation(),this.initializePage(),this.setupAnimations()}async loadProperties(){try{console.log("[RealEstateApp] Fetching properties from static JSON...");const e=await fetch("/data/listings.json");if(!e.ok)throw new Error(`Failed to load listings: ${e.status}`);const t=await e.json();this.properties=t.properties||[],console.info("[RealEstateApp] Loaded properties:",this.properties.length)}catch(e){console.error("[RealEstateApp] Error loading properties:",e),this.properties=[]}}setupLanguageSwitching(){document.querySelectorAll("[data-lang]").forEach(t=>{t.addEventListener("click",a=>{a.preventDefault();const n=t.getAttribute("data-lang");this.switchLanguage(n)})})}setupTheme(){const e=document.getElementById("theme-toggle"),t=document.getElementById("sun-icon"),a=document.getElementById("moon-icon");localStorage.getItem("theme")==="dark"||!localStorage.getItem("theme")?(document.documentElement.classList.add("dark"),t&&t.classList.remove("hidden"),a&&a.classList.add("hidden")):(document.documentElement.classList.remove("dark"),t&&t.classList.add("hidden"),a&&a.classList.remove("hidden")),e&&e.addEventListener("click",()=>{const i=document.documentElement.classList.toggle("dark");localStorage.setItem("theme",i?"dark":"light"),i?(t&&t.classList.remove("hidden"),a&&a.classList.add("hidden")):(t&&t.classList.add("hidden"),a&&a.classList.remove("hidden"))})}updateAdminStats(){const e=document.getElementById("stats-total-properties"),t=document.getElementById("stats-available-properties"),a=document.getElementById("stats-sold-properties"),n=document.getElementById("stats-revenue");if(!e&&!t&&!a&&!n)return;const i=this.properties.length,o=this.properties.filter(m=>(m.status||"").toLowerCase()==="available").length,s=this.properties.filter(m=>(m.status||"").toLowerCase()==="sold").length,r="؋0";e&&(e.textContent=i),t&&(t.textContent=o),a&&(a.textContent=s),n&&(n.textContent=r)}switchLanguage(e){this.currentLanguage=e,localStorage.setItem("language",e);const a=window.location.pathname.split("/").pop().replace("-fa.html","").replace(".html",""),n=window.location.search;let i;e==="fa"?i=a==="index"||a===""?"index-fa.html":a==="listings"?"listings-fa.html":a==="details"?"details-fa.html":"index-fa.html":i=a==="index"||a===""?"index.html":a==="listings"?"listings.html":a==="details"?"details.html":"index.html",window.location.href=i+n}setupNavigation(){document.querySelectorAll("[data-nav]").forEach(t=>{t.addEventListener("click",a=>{t.getAttribute("data-nav")==="admin"&&(a.preventDefault(),this.showAdminLogin())})})}initializePage(){switch(this.getCurrentPage()){case"index":this.initHomepage();break;case"listings":this.initListings();break;case"details":this.initDetails();break;case"admin":this.initAdmin();break}}getCurrentPage(){const e=window.location.pathname;return e.includes("listings")?"listings":e.includes("details")?"details":e.includes("admin")?"admin":"index"}initHomepage(){this.setupHeroCarousel(),this.displayFeaturedProperties(),this.setupQuickSearch(),this.setupOfficeMap()}setupOfficeMap(){const e=document.getElementById("office-map");if(!e)return;const t=()=>{e.dataset.loaded||(e.dataset.loaded="true",e.innerHTML='<div class="w-full h-full flex items-center justify-center bg-gray-100"><p>Loading Map...</p></div>',this.loadGoogleMaps().then(()=>{const a={lat:33.138714,lng:67.4385},n={center:a,zoom:16,mapTypeId:"roadmap",streetViewControl:!0,mapTypeControl:!0},i=new google.maps.Map(e,n),o=new google.maps.Marker({position:a,map:i,title:this.currentLanguage==="fa"?"دفتر املاک امانت":"Amanat Properties Office"}),s=new google.maps.InfoWindow({content:`<div class="p-2 text-center">
                        <h3 class="font-bold">${this.currentLanguage==="fa"?"دفتر املاک امانت":"Amanat Properties Office"}</h3>
                        <p class="text-sm">${this.currentLanguage==="fa"?"سنگی‌مشا، جاغوری، ولایت غزنی":"Sangi-e-Masha, Jaghuri, Ghazni"}</p>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=33.138714,67.4385" target="_blank" class="text-orange-600 font-bold block mt-2">
                            ${this.currentLanguage==="fa"?"دریافت آدرس":"Get Directions"}
                        </a>
                    </div>`});o.addListener("click",()=>{s.open(i,o)})}).catch(a=>{console.error("Map load failed",a),e.innerHTML='<div class="w-full h-full flex items-center justify-center bg-red-50 text-red-500"><p>Map failed to load.</p></div>'}))};if("IntersectionObserver"in window){const a=new IntersectionObserver(n=>{n.forEach(i=>{i.isIntersecting&&(t(),a.disconnect())})},{rootMargin:"200px"});a.observe(e)}else t()}loadGoogleMaps(){return window.google&&window.google.maps?Promise.resolve():this.mapsLoadingPromise?this.mapsLoadingPromise:(this.mapsLoadingPromise=new Promise((e,t)=>{const a=document.createElement("script"),n="YOUR_NEW_KEY_HERE";a.src=`https://maps.googleapis.com/maps/api/js?key=${n}&libraries=places&callback=initMapsCallback`,a.async=!0,a.defer=!0,window.initMapsCallback=()=>e(),a.onerror=t,document.head.appendChild(a)}),this.mapsLoadingPromise)}setupHeroCarousel(){const e=["images/hero_1.webp","images/hero_2.webp","images/hero_3.webp","images/hero_4.webp","images/hero_5.webp","images/hero_6.webp","images/hero_7.webp"],t=document.getElementById("hero-carousel");if(t){let a=0;const n=()=>{t.style.backgroundImage=`url('${e[a]}')`,t.style.backgroundSize="cover",t.style.backgroundPosition="center",a=(a+1)%e.length};n(),setInterval(n,5e3)}}displayFeaturedProperties(){const e=document.getElementById("featured-properties");if(!e)return;const a=[...this.properties].sort((i,o)=>{const s=i.date_added?new Date(i.date_added):new Date(0);return(o.date_added?new Date(o.date_added):new Date(0))-s}).slice(0,4);if(a.length===0){const i=this.currentLanguage==="fa"?"در حال حاضر ملکی برای نمایش در لیست‌های ویژه موجود نیست.":"No properties are available to feature yet.";e.innerHTML=`<div class="col-span-full text-center text-gray-500 py-8">${i}</div>`;return}e.innerHTML=a.map(i=>this.createPropertyCard(i)).join(""),e.querySelectorAll(".property-card").forEach((i,o)=>{i.addEventListener("click",()=>{const s=a[o];s&&s.id&&(window.location.href=`details.html?id=${s.id}`)})})}setupQuickSearch(){const e=document.getElementById("quick-price-range"),t=document.getElementById("quick-search-btn");t&&t.addEventListener("click",()=>{const a=e?e.value:0;window.location.href=`listings.html?minPrice=${a}`})}initListings(){this.setupFilters(),this.sortProperties("date-new"),this.setupSorting()}setupFilters(){document.getElementById("price-slider"),document.querySelectorAll('[data-filter="type"]');const e=document.getElementById("apply-filters");e&&e.addEventListener("click",()=>{this.applyFilters()})}displayProperties(e=null){const t=document.getElementById("properties-grid");if(!t)return;const a=Array.isArray(e),n=a?e:this.properties;if(console.info("[RealEstateApp] displayProperties called — container:",!!t,"properties count:",n.length,"filtered:",a),!n||n.length===0){let s;this.currentLanguage==="fa"?s=a?"هیچ ملکی با فیلترهای انتخاب شده یافت نشد.":"در حال حاضر ملکی برای نمایش موجود نیست.":s=a?"No properties match your current filters.":"No properties are available to display yet.",t.innerHTML=`<div class="col-span-full text-center text-gray-500 py-8">${s}</div>`;const r=document.getElementById("properties-count");r&&(r.textContent=this.currentLanguage==="fa"?0 .toLocaleString("fa-AF"):"0");return}t.innerHTML=n.map(s=>this.createPropertyCard(s)).join(""),t.querySelectorAll(".property-card").forEach((s,r)=>{s.addEventListener("click",()=>{window.location.href=`details.html?id=${n[r].id}`})});const o=document.getElementById("properties-count");if(o){const s=n.length;o.textContent=this.currentLanguage==="fa"?s.toLocaleString("fa-AF"):String(s)}}applyFilters(){const e=document.getElementById("min-price")?.value||0,t=document.getElementById("max-price")?.value||1/0,a=Array.from(document.querySelectorAll('[data-filter="type"]:checked')).map(r=>r.value),n=document.querySelector('[name="bedrooms"]:checked'),i=n?n.value:"0";let o=this.properties.filter(r=>{const m=r.price>=e&&r.price<=t,c=a.length===0||a.includes(r.type),l=(r.type||"").toLowerCase(),d=l==="land"||l==="commercial";let g=!0;const u=typeof r.bedrooms=="number"?r.bedrooms:0;if(!d&&i&&i!=="0"){const p=parseInt(i,10);p===4?g=u>=4:g=u===p}return m&&c&&g});const s=document.getElementById("active-filters");if(s){const r=[];a.length>0&&(this.currentLanguage==="fa"?r.push(`نوع: ${a.join(", ")}`):r.push(`Type: ${a.join(", ")}`));const m=document.getElementById("min-price")?.value,c=document.getElementById("max-price")?.value;if(m||c)if(this.currentLanguage==="fa"){const l=m?`${parseInt(m,10).toLocaleString("fa-AF")}؋`:"۰؋",d=c?`${parseInt(c,10).toLocaleString("fa-AF")}؋`:"بدون محدودیت";r.push(`قیمت: ${l} تا ${d}`)}else{const l=m?`؋${m}`:"؋0",d=c?`؋${c}`:"No limit";r.push(`Price: ${l} – ${d}`)}if(i&&i!=="0")if(this.currentLanguage==="fa"){const l=i==="4"?"۴+":parseInt(i,10).toLocaleString("fa-AF");r.push(`اتاق خواب: ${l}`)}else{const l=i==="4"?"4+":i;r.push(`Bedrooms: ${l}`)}if(r.length===0)s.textContent=this.currentLanguage==="fa"?"فیلترها: هیچ":"Filters: none";else{const l=this.currentLanguage==="fa"?"فیلترها: ":"Filters: ";s.textContent=l+r.join(" | ")}}this.displayProperties(o)}setupSorting(){const e=document.getElementById("sort-select");e?(e.value=e.value||"date-new",this.sortProperties(e.value),e.addEventListener("change",t=>{const a=t.target.value;this.sortProperties(a)})):this.sortProperties("date-new")}sortProperties(e){let t=[...this.properties];switch(e){case"price-low":t.sort((a,n)=>a.price-n.price);break;case"price-high":t.sort((a,n)=>n.price-a.price);break;case"date-old":t.sort((a,n)=>new Date(a.date_added)-new Date(n.date_added));break;case"date-new":t.sort((a,n)=>new Date(n.date_added)-new Date(a.date_added));break;case"area-large":t.sort((a,n)=>(n.area||0)-(a.area||0));break}this.displayProperties(t)}initDetails(){const e=new URLSearchParams(window.location.search),t=parseInt(e.get("id"));if(t){const a=this.properties.find(n=>n.id===t);a&&(this.displayPropertyDetails(a),this.setupImageGallery(),this.setupContactForm(),this.setupWhatsAppIntegration(a))}}displayPropertyDetails(e){const t=document.getElementById("property-title"),a=document.getElementById("property-price"),n=document.getElementById("property-description"),i=document.getElementById("property-features"),o=document.getElementById("property-area"),s=document.getElementById("property-bedrooms"),r=document.getElementById("property-bathrooms"),m=document.getElementById("property-status"),c=document.getElementById("property-bedrooms-block"),l=document.getElementById("property-bathrooms-block");t&&(t.textContent=this.currentLanguage==="fa"?e.title_fa:e.title),a&&(a.textContent=this.formatPrice(e.price)),n&&(n.textContent=this.currentLanguage==="fa"?e.description_fa:e.description);const d=document.getElementById("property-video-container");d&&(e.video_url?(d.innerHTML=`
                    <h3 class="text-2xl font-bold mb-4">${this.currentLanguage==="fa"?"تور ویدیویی":"Video Tour"}</h3>
                    <div class="aspect-w-16 aspect-h-9">
                        <iframe src="${e.video_url}" title="Property Tour" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-full h-64 md:h-96 rounded-lg shadow-lg"></iframe>
                    </div>
                `,d.style.display="block"):d.style.display="none"),o&&typeof e.area<"u"&&e.area!==null&&(this.currentLanguage==="fa"?o.textContent=e.area.toLocaleString("fa-AF"):o.textContent=e.area);const g=(e.type||"").toLowerCase()==="land"||(e.type||"").toLowerCase()==="commercial";if(c&&(c.style.display=g?"none":""),l&&(l.style.display=g?"none":""),g||(s&&typeof e.bedrooms<"u"&&e.bedrooms!==null&&(s.textContent=this.currentLanguage==="fa"?e.bedrooms.toLocaleString("fa-AF"):e.bedrooms),r&&typeof e.bathrooms<"u"&&e.bathrooms!==null&&(r.textContent=this.currentLanguage==="fa"?e.bathrooms.toLocaleString("fa-AF"):e.bathrooms)),m&&e.status&&(m.textContent=e.status),i){const u=this.currentLanguage==="fa"?e.features_fa:e.features;i.innerHTML=u.map(p=>`<li>${p}</li>`).join("")}this.setupMap(e)}setupMap(e){const t=e.lat||33.245,a=e.lng||67.417,n=document.getElementById("map");if(!n)return;const i=()=>{n.dataset.loaded||(n.dataset.loaded="true",n.innerHTML='<div class="w-full h-full flex items-center justify-center bg-gray-100"><p>Loading Property Map...</p></div>',this.loadGoogleMaps().then(()=>{const o={center:{lat:t,lng:a},zoom:15,mapTypeId:"roadmap",streetViewControl:!0,mapTypeControl:!0},s=new google.maps.Map(n,o),r=new google.maps.Marker({position:{lat:t,lng:a},map:s,title:this.currentLanguage==="fa"?e.title_fa:e.title}),m=new google.maps.InfoWindow({content:`<div class="p-2"><strong>${this.currentLanguage==="fa"?e.title_fa:e.title}</strong></div>`});r.addListener("click",()=>{m.open(s,r)})}).catch(o=>{console.error(o),n.innerHTML='<div class="text-red-500 text-center p-4">Map failed to load</div>'}))};if("IntersectionObserver"in window){const o=new IntersectionObserver(s=>{s[0].isIntersecting&&(i(),o.disconnect())},{rootMargin:"200px"});o.observe(n)}else i()}setupImageGallery(){const e=document.getElementById("image-gallery");if(e){const t=new URLSearchParams(window.location.search),a=parseInt(t.get("id")),n=this.properties.find(o=>o.id===a);if(n&&n.images&&n.images.length>0){const o=e.querySelector(".splide__track"),s=o?o.querySelector(".splide__list"):null;if(s){const r=this.getDefaultImageForType(n.type);s.innerHTML=n.images.map((m,c)=>`
                            <li class="splide__slide">
                                <img src="${m}" 
                                     alt="Property Image ${c+1}" 
                                     class="property-image"
                                     onerror="this.onerror=null; this.src='${r}';"
                                     loading="lazy">
                            </li>
                        `).join("")}}new Splide(e,{type:"fade",autoplay:!1,arrows:!0,pagination:!0}).mount()}}setupContactForm(){const e=document.getElementById("contact-form");e&&e.addEventListener("submit",t=>{t.preventDefault(),this.handleContactForm(e)})}setupWhatsAppIntegration(e){const t=document.getElementById("whatsapp-btn");if(t&&e){const a=encodeURIComponent(`Hello, I'm interested in ${e.title} located in ${e.location}. Price: ${this.formatPrice(e.price)}`);t.href=`https://wa.me/${e.contact.replace(/\D/g,"")}?text=${a}`}}handleContactForm(e){const t=new FormData(e),a=Object.fromEntries(t);this.showNotification("Message sent successfully!","success"),e.reset(),console.log("Contact form data:",a)}initAdmin(){this.isAdminLoggedIn?this.setupAdminPanel():this.showAdminLogin()}showAdminLogin(){const e=document.createElement("div");e.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";const t=this.currentLanguage==="fa",a=t?"ورود مدیر":"Admin Login",n=t?"رمز عبور":"Password",i=t?"ورود":"Login",o=t?"انصراف":"Cancel",s=t?'نیاز به تغییر رمز عبور دارید؟ با <a href="mailto:propertiesamanat@gmail.com" class="text-blue-500 hover:underline">propertiesamanat@gmail.com</a> در تماس شوید':'Need to change the password? Contact <a href="mailto:propertiesamanat@gmail.com" class="text-blue-500 hover:underline">propertiesamanat@gmail.com</a>';e.innerHTML=`
            <div class="bg-white dark:bg-gray-800 p-8 rounded-lg max-w-md w-full relative shadow-xl" dir="${t?"rtl":"ltr"}">
                <button type="button" id="close-admin-modal" class="absolute top-4 ${t?"left-4":"right-4"} text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-white">${a}</h2>
                <form id="admin-login-form">
                    <input type="password" id="admin-password" placeholder="${n}" class="w-full p-2 border rounded mb-4 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded mb-3 transition-colors">${i}</button>
                    <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-3">
                        ${s}
                    </p>
                    <button type="button" id="cancel-admin-login" class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 p-2 rounded transition-colors">${o}</button>
                </form>
            </div>
        `,document.body.appendChild(e),setTimeout(()=>{const d=e.querySelector("#admin-password");d&&d.focus()},100);const r=()=>{document.body.contains(e)&&document.body.removeChild(e)},m=e.querySelector("#close-admin-modal"),c=e.querySelector("#cancel-admin-login");m&&m.addEventListener("click",r),c&&c.addEventListener("click",r),e.querySelector("#admin-login-form").addEventListener("submit",d=>{d.preventDefault();const g=e.querySelector("#admin-password").value;this.validateAdminPassword(g)?(this.isAdminLoggedIn=!0,localStorage.setItem("adminLoggedIn","true"),r(),this.getCurrentPage()==="admin"?this.setupAdminPanel():window.location.href="admin.html"):this.showNotification("Invalid password","error")}),e.addEventListener("click",d=>{d.target===e&&r()})}validateAdminPassword(e){return e==="admin123"}setupAdminPanel(){this.displayAdminProperties(),this.setupAdminForms(),this.updateAdminStats()}displayAdminProperties(){const e=document.getElementById("admin-properties");e&&(e.innerHTML=this.properties.map(t=>`
            <tr class="border-b table-row">
                <td class="p-2">${t.id}</td>
                <td class="p-2">${t.title||"N/A"}</td>
                <td class="p-2">${t.type||"N/A"}</td>
                <td class="p-2">${this.formatPrice(t.price||0)}</td>
                <td class="p-2">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${t.status==="Available"?"bg-green-100 text-green-800":t.status==="Sold"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}">${t.status||"Available"}</span>
                </td>
                <td class="p-2">
                    <button onclick="app.editProperty(${t.id})" class="bg-blue-500 text-white px-2 py-1 rounded mr-2 hover:bg-blue-600">Edit</button>
                    <button onclick="app.deleteProperty(${t.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Delete</button>
                </td>
            </tr>
        `).join(""),this.updateAdminStats())}setupAdminForms(){const e=document.getElementById("add-property-form");e&&(this.loadGoogleMaps().then(()=>{this.setupMapPicker("add-property-map","add-lat","add-lng","add-coords",33.245,67.417)}).catch(n=>console.error("Map load failed",n)),e.addEventListener("submit",n=>{n.preventDefault(),this.addProperty(e)}));const t=document.getElementById("edit-property-form");t&&t.addEventListener("submit",n=>{n.preventDefault(),this.updateProperty(t)});const a=document.getElementById("close-edit-modal");a&&a.addEventListener("click",()=>{document.getElementById("edit-property-modal").classList.add("hidden"),this.editingProperty=null})}setupMapPicker(e,t,a,n,i,o){const s=document.getElementById(e);if(!s||typeof google>"u")return;const r={center:{lat:i,lng:o},zoom:15,mapTypeId:"roadmap",streetViewControl:!1,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU,mapTypeIds:["roadmap","satellite","hybrid"]}},m=new google.maps.Map(s,r),c=new google.maps.Marker({position:{lat:i,lng:o},map:m,draggable:!0,title:"Property Location"}),l=(d,g)=>{const u=document.getElementById(t),p=document.getElementById(a),f=document.getElementById(n);u&&(u.value=d.toFixed(6)),p&&(p.value=g.toFixed(6)),f&&(f.textContent=`${d.toFixed(6)}, ${g.toFixed(6)}`)};l(i,o),c.addListener("dragend",()=>{const d=c.getPosition();l(d.lat(),d.lng())}),m.addListener("click",d=>{const g=d.latLng.lat(),u=d.latLng.lng();c.setPosition({lat:g,lng:u}),l(g,u)})}addProperty(e){const t=new FormData(e),a={id:Date.now(),title:t.get("title"),title_fa:t.get("title_fa"),type:t.get("type"),type_fa:t.get("type_fa")||t.get("type"),price:parseInt(t.get("price")),area:parseInt(t.get("area")),bedrooms:parseInt(t.get("bedrooms")),bathrooms:parseInt(t.get("bathrooms")),location:t.get("location"),location_fa:t.get("location_fa"),lat:parseFloat(t.get("lat")),lng:parseFloat(t.get("lng")),description:t.get("description"),description_fa:t.get("description_fa"),status:"Available",images:window.pendingUploadImages&&window.pendingUploadImages.length?window.pendingUploadImages.slice():["hero-villa.jpg"],features:t.get("features").split(",").map(i=>i.trim()),features_fa:t.get("features_fa")?t.get("features_fa").split(",").map(i=>i.trim()):[],contact:t.get("contact"),date_added:new Date().toISOString().split("T")[0]};(()=>{if(window.pendingUploadImages){const o=window.pendingUploadImages.filter(s=>s!==null);o.length>0&&(a.images=o)}this.properties.push(a);try{localStorage.setItem("properties",JSON.stringify(this.properties))}catch(o){console.warn("LocalStorage error:",o)}this.displayAdminProperties(),this.showNotification("Property added locally.","success"),e.reset();const i=new CustomEvent("resetFileUpload");window.dispatchEvent(i),window.pendingUploadImages=[],window.pendingUploadFiles=[]})()}updateProperty(e){const t=new FormData(e),a=t.get("id"),n=this.properties.findIndex(o=>String(o.id)===String(a));if(n===-1){this.showNotification("Property not found","error");return}const i={...this.properties[n],title:t.get("title"),title_fa:t.get("title_fa"),type:t.get("type"),type_fa:t.get("type_fa"),price:parseInt(t.get("price")),area:parseInt(t.get("area")),bedrooms:parseInt(t.get("bedrooms")),bathrooms:parseInt(t.get("bathrooms")),location:t.get("location"),location_fa:t.get("location_fa"),lat:parseFloat(t.get("lat")),lng:parseFloat(t.get("lng")),contact:t.get("contact"),description:t.get("description"),description_fa:t.get("description_fa"),features:t.get("features").split(",").map(o=>o.trim()).filter(Boolean),features_fa:t.get("features_fa").split(",").map(o=>o.trim()).filter(Boolean)};if(window.editPendingUploadImages){const o=window.editPendingUploadImages.filter(s=>s!==null);o.length>0&&(i.images=[...i.images||[],...o])}this.properties[n]=i,this.finishUpdate()}finishUpdate(){localStorage.setItem("properties",JSON.stringify(this.properties)),this.displayAdminProperties(),this.showNotification("Property updated successfully","success"),document.getElementById("edit-property-modal").classList.add("hidden"),window.editPendingUploadFiles=null,window.editPendingUploadImages=null}editProperty(e){const t=this.properties.find(i=>String(i.id)===String(e));if(!t){this.showNotification("Property not found!","error");return}document.getElementById("edit-property-id").value=t.id,document.getElementById("edit-title").value=t.title||"",document.getElementById("edit-title-fa").value=t.title_fa||"",document.getElementById("edit-type").value=t.type||"",document.getElementById("edit-type-fa").value=t.type_fa||"",document.getElementById("edit-price").value=t.price||0,document.getElementById("edit-area").value=t.area||"",document.getElementById("edit-bedrooms").value=t.bedrooms||"",document.getElementById("edit-bathrooms").value=t.bathrooms||"",document.getElementById("edit-location").value=t.location||"",document.getElementById("edit-location-fa").value=t.location_fa||"",document.getElementById("edit-contact").value=t.contact||"",document.getElementById("edit-status").value=t.status||"Available",document.getElementById("edit-description").value=t.description||"",document.getElementById("edit-description-fa").value=t.description_fa||"",document.getElementById("edit-features").value=Array.isArray(t.features)?t.features.join(", "):t.features||"",document.getElementById("edit-features-fa").value=Array.isArray(t.features_fa)?t.features_fa.join(", "):t.features_fa||"";const a=document.getElementById("current-images-preview");t.images&&t.images.length>0?a.innerHTML=`
                <p class="text-sm font-semibold text-gray-700 mb-2">Current Images (${t.images.length}):</p>
                <div class="grid grid-cols-4 gap-2">
                    ${t.images.map(i=>`
                        <div class="relative">
                            <img src="${i}" alt="Property image" class="w-full h-20 object-cover rounded border">
                            <button type="button" onclick="app.removeImageFromEdit('${i}', ${e})" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600">×</button>
                        </div>
                    `).join("")}
                </div>
            `:a.innerHTML='<p class="text-sm text-gray-500">No images currently</p>',this.initializeEditImageSlots();const n=document.getElementById("edit-property-modal");if(n){n.classList.remove("hidden");const i=t.lat||33.245,o=t.lng||67.417;setTimeout(()=>{this.loadGoogleMaps().then(()=>{this.setupMapPicker("edit-property-map","edit-lat","edit-lng","edit-coords",i,o)})},100)}this.editingProperty=t}initializeEditImageSlots(){const e=document.getElementById("edit-image-slots");if(!e)return;const t=30;e.innerHTML="";for(let a=0;a<t;a++){const n=document.createElement("div");n.className="border-2 border-dashed border-gray-300 rounded-lg p-3 flex flex-col items-center justify-center text-center bg-gray-50",n.innerHTML=`
                <div class="w-full h-24 bg-gray-100 rounded mb-2 flex items-center justify-center overflow-hidden" id="edit-slot-preview-${a}">
                    <span class="text-gray-400 text-sm">No image</span>
                </div>
                <input type="file" accept="image/*" class="hidden" id="edit-image-slot-input-${a}">
                <button type="button" class="px-3 py-1 rounded bg-white border border-gray-300 text-sm hover:border-orange-400" data-slot="${a}">
                    Select image ${a+1}
                </button>
                <p class="text-xs text-gray-500 mt-1">Max 5MB</p>
            `,e.appendChild(n);const i=n.querySelector("button"),o=n.querySelector('input[type="file"]'),s=n.querySelector(`#edit-slot-preview-${a}`);i.addEventListener("click",()=>o.click()),o.addEventListener("change",r=>this.handleEditSlotFile(a,r.target.files?r.target.files[0]:null,s))}window.editPendingUploadFiles||(window.editPendingUploadFiles=new Array(t).fill(null),window.editPendingUploadImages=new Array(t).fill(null))}handleEditSlotFile(e,t,a){if(!a)return;const n=5*1024*1024,i=document.getElementById("edit-image-error");if(!t){window.editPendingUploadFiles[e]=null,window.editPendingUploadImages[e]=null,a.innerHTML='<span class="text-gray-400 text-sm">No image</span>';return}if(!t.type||!t.type.startsWith("image/")){i&&(i.textContent="Only image files are allowed.",i.classList.remove("hidden"));return}if(t.size>n){i&&(i.textContent="File too large (max 5MB).",i.classList.remove("hidden"));return}const o=new FileReader;o.onload=()=>{window.editPendingUploadFiles[e]=t,window.editPendingUploadImages[e]=o.result,a.innerHTML=`<img src="${o.result}" alt="Preview" class="w-full h-24 object-cover rounded">`,i&&(i.textContent="",i.classList.add("hidden"))},o.readAsDataURL(t)}async removeImageFromEdit(e,t){const a=this.properties.find(i=>String(i.id)===String(t));if(!a)return;const n=this.currentLanguage==="fa"?"آیا مطمئن هستید که میخواهید این تصویر را حذف کنید؟":"Are you sure you want to remove this image?";if(confirm(n)){a.images=a.images.filter(o=>o!==e);const i=this.properties.findIndex(o=>o.id===t);i!==-1&&(this.properties[i]=a);try{localStorage.setItem("properties",JSON.stringify(this.properties))}catch{}this.showNotification("Image removed locally.","success"),this.editProperty(t)}}deleteProperty(e){const t=this.currentLanguage==="fa"?"آیا مطمئن هستید که میخواهید این ملک را حذف کنید؟":"Are you sure you want to delete this property?";if(confirm(t)){this.properties=this.properties.filter(a=>String(a.id)!==String(e));try{localStorage.setItem("properties",JSON.stringify(this.properties))}catch(a){console.warn("LocalStorage error:",a)}this.displayAdminProperties(),this.showNotification("Property deleted locally.","success")}}createPropertyCard(e){const t=this.currentLanguage==="fa"?e.title_fa:e.title,a=this.currentLanguage==="fa"?e.location_fa:e.location,n=(e.type||"").toLowerCase()==="land"||(e.type||"").toLowerCase()==="commercial";let i=!1;if(e.date_added){const l=new Date(e.date_added);i=(new Date-l)/(1e3*60*60*24)<=30}const o=e.thumbnail||(e.images&&e.images.length>0?e.images[0]:null)||this.getDefaultImageForType(e.type),s=this.getDefaultImageForType(e.type),r=this.currentLanguage==="fa"?"جدید":"New",m=this.currentLanguage==="fa"?"مشاهده جزئیات":"View Details";let c="";if(Array.isArray(e.features)&&e.features.length>0){const l=e.features,d=(e.type||"").toLowerCase();d==="land"?c=l.find(g=>/development|ready/i.test(g))||l.find(g=>/investment/i.test(g))||l[0]:d==="commercial"?c=l.find(g=>/prime/i.test(g))||l.find(g=>/high traffic/i.test(g))||l[0]:c=l[0]}return this.currentLanguage==="fa"&&Array.isArray(e.features_fa)&&e.features_fa.length>0&&(c=e.features_fa[0]||c),`
            <div class="property-card bg-white rounded-lg shadow-lg overflow-hidden cursor-pointer transform transition-transform hover:scale-105">
                <div class="relative">
                    <img src="${o}" 
                         alt="${t}" 
                         class="w-full h-48 object-cover property-image"
                         onerror="this.onerror=null; this.src='${s}';"
                         loading="lazy">
                    <div class="absolute top-2 left-2 bg-white/90 text-gray-800 text-xs font-semibold px-2 py-1 rounded">
                        Listing #${e.id}
                    </div>
                    ${i?`<div class="absolute top-2 right-2 bg-orange-500 text-white text-xs font-semibold px-2 py-1 rounded-full shadow"> ${r} </div>`:""}
                </div>
                <div class="p-4 flex flex-col gap-2">
                    <h3 class="text-xl font-bold mb-2">${t}</h3>
                    <p class="text-gray-600 mb-2">${a}</p>
                    <p class="text-2xl font-bold text-blue-600 mb-2">${this.formatPrice(e.price)}</p>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>${e.area} m²</span>
                        <div class="flex gap-2">
                            ${!n&&e.bedrooms>0?`<span>${e.bedrooms} Beds</span>`:""}
                            ${!n&&e.bathrooms>0?`<span>${e.bathrooms} Baths</span>`:""}
                        </div>
                    </div>
                    ${c?`<div class="mt-1 inline-flex px-2 py-1 rounded-full bg-orange-50 text-xs font-medium text-orange-700 border border-orange-100">
                               ${c}
                           </div>`:""}
                    <div class="mt-2">
                        <button class="text-sm text-orange-600 font-semibold hover:underline">
                            ${m}
                        </button>
                    </div>
                </div>
            </div>
        `}getDefaultImageForType(e){return{Villa:"hero-villa.jpg",Apartment:"hero-apartment.jpg",Commercial:"hero-commercial.jpg",House:"hero-villa.jpg",Land:"hero-commercial.jpg"}[e]||"hero-villa.jpg"}formatPrice(e){return this.currentLanguage==="fa"?e>=1e5?Math.floor(e/1e5).toLocaleString("fa-AF")+" لک افغانی":e.toLocaleString("fa-AF")+" افغانی":`؋${(e/1e6).toFixed(1)}M`}showNotification(e,t="info"){const a=document.createElement("div");a.className=`fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${t==="success"?"bg-green-500":t==="error"?"bg-red-500":t==="warning"?"bg-yellow-500":"bg-blue-500"}`,a.textContent=e,document.body.appendChild(a),setTimeout(()=>{document.body.contains(a)&&document.body.removeChild(a)},3e3)}setupAnimations(){typeof anime<"u"&&anime({targets:".fade-in",opacity:[0,1],translateY:[20,0],duration:800,delay:anime.stagger(100)})}}const w=new y;window.app=w;
